rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user data
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && getUserData().role == 'admin';
    }
    
    // Helper function to check if user is sales rep
    function isSalesRep() {
      return isAuthenticated() && getUserData().role == 'representative';
    }
    
    // Helper function to check if user owns the business
    function ownsBusiness(businessId) {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/businesses/$(businessId)).data.ownerId == request.auth.uid;
    }
    
    // Helper function to check if user belongs to business (owner or sales rep)
    function belongsToBusiness(businessId) {
      return isAuthenticated() && (
        // Admin owns the business
        (getUserData().role == 'admin' && 
         get(/databases/$(database)/documents/businesses/$(businessId)).data.ownerId == request.auth.uid) ||
        // Sales rep assigned to this business (businessId in user doc matches)
        (getUserData().role == 'representative' && 
         getUserData().businessId == businessId)
      );
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // Allow creating user document:
      // 1. Public signup (admin) - no businessId or businessId is null, role can be anything (defaults to admin)
      // 2. Sales rep signup via invitation - has businessId and role is 'representative'
      allow create: if isAuthenticated() && request.auth.uid == userId && 
                       !exists(/databases/$(database)/documents/users/$(userId)) &&
                       (
                         // Admin signup: businessId is null or not present
                         (request.resource.data.businessId == null) ||
                         // Sales rep signup via invitation: has businessId and role is 'representative'
                         (request.resource.data.businessId != null &&
                          request.resource.data.role == 'representative')
                       );
      
      // Allow updating user document when accepting invitation (sales rep linking)
      // User must not already have a businessId, and must be setting role to 'representative'
      allow update: if isAuthenticated() && request.auth.uid == userId &&
                       (
                         // User doesn't have businessId yet (must be null or not exist)
                         resource.data.businessId == null &&
                         // Setting businessId and role to representative
                         request.resource.data.businessId != null &&
                         request.resource.data.role == 'representative'
                       );
      allow delete: if false;
    }
    
    // Businesses collection
    match /businesses/{businessId} {
      // Allow read if:
      // 1. User owns the business (ownerId matches authenticated user)
      // 2. OR user is a sales rep assigned to this business
      allow read: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        (getUserData().role == 'representative' && 
         getUserData().businessId == businessId)
      );
      // Allow create if user is authenticated admin and setting themselves as owner
      allow create: if isAuthenticated() && 
                       request.resource.data.ownerId == request.auth.uid &&
                       request.resource.data.salesRepIds is list;
      // Allow update if:
      // 1. User owns the business (admin updating settings)
      // 2. OR only salesRepIds is being updated (for invitation acceptance - slightly permissive but necessary)
      allow update: if isAuthenticated() && (
        ownsBusiness(businessId) ||
        // Allow updating salesRepIds array (used during invitation acceptance)
        // This is necessary because the user accepting invitation doesn't own the business yet
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['salesRepIds'])
      );
      // Allow delete if user owns the business (admin only)
      allow delete: if ownsBusiness(businessId);
    }
    
    // Invitations collection
    match /invitations/{invitationId} {
      // Allow read if user is authenticated
      // For signup flow: User queries by token, email is verified in app logic
      // For existing users: Email must match (checked in app, but also allow if matches)
      // Note: Email verification happens in the application code before accepting invitation
      allow read: if isAuthenticated();
      
      // Allow create if user is admin and owns the business
      allow create: if isAuthenticated() && 
                       ownsBusiness(request.resource.data.businessId);
      
      // Allow update if user is authenticated and accepting invitation
      // Email must match and status must be pending -> accepted
      allow update: if isAuthenticated() && 
                       resource.data.email == request.auth.token.email &&
                       resource.data.status == 'pending' &&
                       request.resource.data.status == 'accepted';
      
      // Allow delete if user owns the business
      allow delete: if isAuthenticated() && 
                       ownsBusiness(resource.data.businessId);
    }
    
    // Products collection
    match /products/{productId} {
      allow read: if belongsToBusiness(resource.data.businessId);
      allow create: if belongsToBusiness(request.resource.data.businessId);
      allow update: if belongsToBusiness(resource.data.businessId);
      allow delete: if ownsBusiness(resource.data.businessId);
    }
    
    // Sales collection
    match /sales/{saleId} {
      allow read: if belongsToBusiness(resource.data.businessId);
      allow create: if belongsToBusiness(request.resource.data.businessId);
      allow update: if false; // Sales should not be modified after creation
      allow delete: if ownsBusiness(resource.data.businessId);
    }
  }
}

